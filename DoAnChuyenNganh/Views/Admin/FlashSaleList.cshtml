@model IPagedList<DoAnChuyenNganh.ViewModel.FlashSaleListViewModel>
@using PagedList;

@{
    ViewData["Title"] = "Flash Sale List";
    Layout = "~/Views/Shared/LayoutAdmin.cshtml";
}
<style>
    .table img {
        max-height: 100px;
        object-fit: cover;
    }

    #searchSection {
        margin-bottom: 20px;
    }

    .table-responsive img {
        max-height: 120px;
    }
</style>

<div class="container mt-4">
    <h2 class="text-center mb-4">DANH SÁCH FLASH SALE</h2>

    <!-- Phần tìm kiếm -->
    <div class="row mb-3" id="searchSection">
        <div class="col-md-6 col-12">
            <form method="post" action="@Url.Action("SearchFlashSale", "Admin")" id="searchForm">
                <div class="input-group">
                    <input id="searchKeyword" class="form-control" type="search" name="searchKeyword"
                           placeholder="Nhập từ khóa tìm kiếm" aria-label="Search">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </form>
            <ul id="suggestions" class="list-group" style="display:none;"></ul>
        </div>
    </div>

    <!-- Thêm thông báo nếu có -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }

    <!-- Card danh sách flash sale -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover text-center">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ảnh sản phẩm</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá khuyến mãi</th>
                            <th>Thời gian bắt đầu</th>
                            <th>Thời gian kết thúc</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (var i = 0; i < Model.Count; i++)
                        {
                            <tr>
                                <td>@(Model.PageNumber * Model.PageSize - Model.PageSize + i + 1)</td>
                                <td>
                                    <img src="@Model[i].ProductImage" alt="Ảnh sản phẩm" width="100" class="img-thumbnail" />
                                </td>
                                <td>@Model[i].ProductName</td>
                                <td>@String.Format("{0:N0}", Model[i].SalePrice) VNĐ</td>
                                <td>@Model[i].StartTime.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@Model[i].EndTime.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Phần Pagination -->
    <div class="text-center mt-3">
        @for (var i = 1; i <= Model.PageCount; i++)
        {
            if (i == Model.PageNumber)
            {
                <span class="btn btn-secondary disabled">@i</span>
            }
            else
            {
                <a class="btn btn-primary" href="@Url.Action("FlashSaleList", new { page = i })">@i</a>
            }
        }
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        let debounceTimer; // Timer để debounce cho AJAX

        // Gợi ý hiển thị sau khi gõ từ khóa
        $('#searchKeyword').on('input', function () {
            const keyword = $(this).val();
            clearTimeout(debounceTimer); // Clear nếu đang gõ

            if (keyword.length >= 2) {
                debounceTimer = setTimeout(function () { // Gọi AJAX sau 300ms không gõ nữa
                    fetchSuggestions(keyword);
                }, 300);
            } else {
                $('#suggestions').hide();
            }
        });

        // Hàm gọi AJAX để lấy gợi ý
        function fetchSuggestions(keyword) {
            $.ajax({
                url: '@Url.Action("GetFlashSaleSearchSuggestions", "Admin")',
                type: 'GET',
                data: { keyword: keyword },
                success: function (data) {
                    $('#suggestions').empty();
                    if (data.length > 0) {
                        $('#suggestions').show();
                        data.forEach(function (item) {
                            $('#suggestions').append(
                                `<li class="list-group-item suggestion-item" style="cursor:pointer;">${item}</li>`
                            );
                        });
                    } else {
                        $('#suggestions').hide();
                    }
                },
                error: function () {
                    $('#suggestions').hide();
                }
            });
        }

        $(document).on('click', '.suggestion-item', function () {
            const selectedItem = $(this).text();
            $('#searchKeyword').val(selectedItem);
            $('#suggestions').hide();
            searchFlashSale(selectedItem);
        });

        $(document).on('click', function (event) {
            if (!$(event.target).closest('#searchSection').length) {
                $('#suggestions').hide();
            }
        });

        $(document).on('focusout', '#searchKeyword', function () {
            setTimeout(function () {
                $('#suggestions').hide();
            }, 100);
        });
    });

</script>